# DNS基础知识

------

http://www.xxorg.com/archives/2291

http://blog.csdn.net/yangfanacc/article/details/42099913

## 基础概念

**根域、顶级域、二级域、子域**
域名采用层次化的方式进行组织，每一个点代表一个层级。一个域名完整的格式为www.baidu.com. 最末尾的点代表根域，常常省略；com即顶级域（TLD）；baidu.com即二级域。依次类推，还有三级域、四级域等等。子域是一个相对的概念，baidu.com是com的子域，www.baidu.com是baidu.com的子域。


**域名系统**  即DNS（Domain Name System）。DNS主要解决两方面的问题：域名本身的增删改查以及域名到IP如何映射。

**正向解析**  查找域名对应IP的过程

**反向解析**  查找IP对应域名的过程

**解析器**  即resolver，处于DNS客户端的一套系统，用于实现正向解析或者反向解析。

**权威DNS**  权威DNS是**经过上一级授权对域名进行解析的服务器，同时它可以把解析授权转授给其他人**，如COM顶级服务器可以授权xxorg.com这个域名的的权威服务器为NS.ABC.COM，同时NS.ABC.COM还可以把授权转授给NS.DDD.COM，这样NS.DDD.COM就成了ABC.COM实际上的权威服务器了。**平时我们解析域名的结果都源自权威DNS**。比如xxorg.com的权威DNS服务器就是dnspod的F1G1NS1.DNSPOD.NET和F1G1NS2.DNSPOD.NET

**递归DNS**   又叫local dns。递归DNS可以理解为是一种功能复杂些的resolver，其核心功能**一个是缓存、一个是递归查询**。收到域名查询请求后其首先看本地缓存是否有记录，如果没有则一级一级的查询根、顶级域、二级域……直到获取到结果然后返回给用户。日常上网中运营商分配的DNS即这里所说的递归DNS。

```
递归DNS负责接受用户对任意域名查询，并返回结果给用户。递归DNS的工作过程参见本文第二节。递归DNS可以缓存结果以避免重复向上查询。我们平时使用最多的就是这类DNS，他对公众开放服务，一般由网络运营商提供，大家都自己可以架递归DNS提供服务。递归DNS一定要有可靠的互联网连接方可使用。比如谷歌的8.8.8.8和8.8.4.4以及114的114.114.114.114和114.114.115.115都属于这一类DNS。你本地电脑上设置的DNS就是这类DNS。醒醒的习惯是设置114.114.114.114和8.8.8.8这两个，更可靠一点。

```

**转发DNS**  转发DNS是一种特殊的递归。如果本地的缓存记录中没有相应域名结果时，其将查询请求转发给另外一台DNS服务器，由另外一台DNS服务器来完成查询请求。

**公共DNS**  公共DNS属于递归DNS。其典型特征为对外一个IP，为所有用户提供公共的递归查询服务。

## 问题补充

* 递归服务器怎么知道根权威服务器的地址？

在递归服务器上都保存有一份根服务器的地址列表。最新的根服务器地址列表在这里可以得到 ftp://ftp.internic.net/domain/named.root

* 递归服务器每次查询域名都要向根那里找权威服务器吗？

不是的，一旦成功一次，递归服务器就会把权威服务器列表**缓存**下来（如COM顶级服务器列表可以缓存48小时）

* DNS是什么人在管理？

**本地递归服务**器一般由**电信运营商**架设，服务于自己的用户，并有其管理，自然人也架设。**根服务器**与**顶级域服务器**由国际组织统一部署管理（实际控制器在美国政府）。对顶级域服务器来说销售商有可控的写入权

## DNS服务器类型（主域名服务器、辅域名服务器等）
参见此文[DNS域名服务器的类型](http://54im.com/linux/dns-primary-slave-stealth-caching-forwarding.html)

## 域名市场

* 域名交易

作为互联网最重要的轻资产之一，域名原生就具有着投资和品牌价值。围绕域名相关的交易，目前已经衍生出包括注册、买卖、中介、抢注、投资、停放、备案等的一个完整生态系统。

**域名注册** 向有资质的注册商申请一个域名的过程。国内知名的注册商有万网、35互联、中国数据等，可注册常见的.com、.cn、.net、.org等域名；国外知名的有godaddy、enom等。

**域名买卖，域名中介、域名经纪** 围绕域名的评估、分析、谈判、购买、出售等一系列过程。可类比房地产行业。

**域名抢注**  分两种情况，一种是抢注**未被注册过的域名**，一种是抢注曾经**被注册过但是未能在有效期结束前及时续费的域名**。国内外都有不少专门提供域名抢注服务的平台。

**域名投资** 注册和购买有价值的域名，然后获利转让的行为。投资者一般被称为“玉米虫”。2014年比较热门的几次投资事件一个是罗永浩的t.tt，号称成交价200万元；一个是雷军的mi.com，号称成交价360万美元；一个是莫天全的fang.com，成交价格不详。

**域名停放**  将未建站的域名解析到广告页面，利用域名的自然流量来获取收入的方式。提供域名停放服务依赖以下两点：优质广告资源和防作弊技术。

**域名解析** 域名市场除了包含各种类别的交易服务以外，另还包含解析服务。按照功能不同，域名解析服务可以分为如下几类：

**权威DNS**  国内典型的代表是dnspod，其他相关介绍见上文

**公共DNS**  公共DNS类似于运营商的local dns，本质上讲是一种**递归解析服**务。与运营商DNS不同的是，公共DNS一般以一个或两个非常容易记住的IP方式（如百度公共DNS服务IP：180.76.76.76）给所有用户提供统一服务。公共DNS相对于运营商DNS的优势主要在无劫持、更快、更稳定、更安全等。

**CDN DNS**  本质上讲也是一种权威DNS，主要在CDN的业务场景中提供**流量调度功能**。用户将域名CNAME或者直接NS托管到CDN DNS，CDN DNS进一步做**智能调度**返回一个离用户最近的接入节点。用户访问接入节点，享受CDN提供的**缓存、加速、以及防攻击服务**。


## 域名安全威胁

#### 安全事件
* 2009年5月19日南方六省断网事件。一起由于游戏私服私斗打挂dnspod，殃及暴风影音域名解析，然后进一步殃及电信localdns，从而爆发六省大规模断网的事故。事件影响深远。

* 2010年1月12日百度域名劫持事件。baidu.com的NS记录被伊朗网军（Iranian Cyber Army）劫持，然后导致www.baidu.com无法访问。事件持续时间8小时，是百度成立以来最严重的故障事件，直接经济损失700万人民币。

* 2013年5月4日DNS劫持事件。由于主流路由器厂商安全漏洞而导致的全网劫持事件，号称影响了800万用户。

* 2013年8月25日CN域被攻击事件。cn域dns受到DoS攻击而导致所有cn域名无法解析事故。

* 2014年1月21日全国DNS故障。迄今为止，大陆境内发生的最为严重的DNS故障，**所有通用顶级域（.com/.net/.org）遭到DNS污染**，所有的域名全被指向了位于美国的一个IP地址（65.49.2.178）

#### 攻击手段

* **query flood**  通过不断的发DNS请求报文来耗尽目的DNS资源，形成**拒绝服务**。具体分类包括源IP是否随机以及目的域名是否随机等。

* **response flood**  通过不断的发DNS响应报文来达到拒绝服务的目的。
udp floodv  DNS底层协议为UDP，基于UDP的各种flood攻击也都会给DNS带来危害。

* **折射攻击（反射攻击）**  伪造源IP为第三方，借助DNS的回包来达到DoS掉第三方的目的。属于“借刀杀人”的手段。

*  **放大攻击**  折射攻击的一种。通过恶意的构造响应报文来达到流量放大作用，从而对第三方形成带宽攻击。请求报文几十字节，响应报文几千字节，意味着可以形成百倍以上流量放大系数

* **缓存投毒**  每一台DNS都有缓存，缓存投毒指的是通过恶意手段**污染DNS缓存**，形成DNS劫持或者拒绝服务

* **漏洞攻击**  利用各种漏洞来达到入侵并控制DNS服务器目的。漏洞不仅仅指DNS程序本身的，也有可能是机器或者网络其它的“问题点”

* **社会工程学手段**  所有的系统都需要人的维护，而人永远是安全中最脆弱的一环

#### 防御手段
对于**权威DNS**来说，由于请求来源多是**运营商或者公共DNS厂商**的递归DNS，源IP相对比较固定，可以实施**源IP白名单策**略。该策略对于伪造源IP的攻击具有一定削弱作用。

对于**域名随机**的攻击来说，如果权威DNS本身承载的域名量不是很大，可以考虑域名白名单策略。如果源IP就是运营商的，然后请求域名也是合法的，只能靠一定限速策略以及DNS服务器本身性能了。

对于**递归DNS**来说，各种白名单策略误伤都会很严重，因此也主要靠DNS服务器本身性能了

**高性能DNS服务器**目前比较流行的做法是基于Intel DPDK来实施。
另外一种推荐实施的策略是RRL（Response Rate Limit），该策略对于防御折射攻击/放大攻击有一定效果。尽管折射攻击的目标不是DNS本身，但是不防御的话如果把第三方打挂仍然会产生连带责任，因此建议实施RRL。

## 国内常用公共DNS服务器、各省运营商DNS服务器汇总

* 参考自此文[国内常用公共DNS服务器、各省运营商DNS服务器汇总](http://www.jianshu.com/p/dc044b7ca8c9) 或 [国内常用公共DNS服务器、各省运营商DNS服务器汇总](http://www.francissoung.com/2016/03/14/%E5%B8%B8%E7%94%A8%E5%85%AC%E5%85%B1DNS%E6%9C%8D%E5%8A%A1%E5%99%A8/)

* [国内常用DNS列表](https://ip.cn/dns.html)

---
[参考一 - DNS详解，权威DNS，递归DNS，转发DNS，公共DNS](http://blog.csdn.net/yangfanacc/article/details/42099913)

[参考二 - DNS域名服务器的类型](http://54im.com/linux/dns-primary-slave-stealth-caching-forwarding.html)

[参考三 - DNS 分类与区别 ](http://www.xxorg.com/archives/2291)


2017.09.28
