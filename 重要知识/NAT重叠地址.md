# NAT相关内容

## 基础概念

* 内部本地地址：分配给内部网络中的主机的IP地址，通常是私有地址。
* 内部全局地址：合法的IP地址，通常由ISP提供，全局唯一的。
* 外部全局地址：外部网络中的主机的IP地址，来自全局可路由的地址空间。
* 外部本地地址：在内部网络中看到的外部主机的IP地址，通常是私有地址

## 重叠地址下部署IpSec(两内网重叠公司地址合并问题)

**本文参考自[在地址重叠环境中部署IPSec](http://xuanbo.blog.51cto.com/499334/410541/)**

部署IPSec VPN时，经常会遇到内网地址重叠的现象，比如一家公司将另外一家收购之后，**两家公司的内网地址都是同一网段**，如果使用普通的方式实现IPSec VPN，则会增加难度，下面需要使用NAT技术与IPSec技术，在不改变内网地址结构的情况下，实现IPSec VPN。

本文档通过下面的实例来讲述其配置过程，具体网络结构如下拓扑图所示。
![](http://ouzh4pejg.bkt.clouddn.com/nat.jpg)

要互联相同的地址段，需要通过NAT实现地址转换；

假设原两个公司内网都是172.16.1.1，则转换后，对于总公司来说，需要将分公司的内网网段转换为10.1.1.0/24，对于分公司来说，需要将总公司的内网网段转换为10.2.2.0/24

NAT转换只用在一台路由器上做设置如下：

ip nat inside source static network 192.168.1.0 10.2.2.0 /24

ip nat outside source static network 192.168.1.0 10.1.1.0 /24

将总公司的内网换成10.2.2.0/24，分公司的内网换成10.1.1.0/24，当总公司访问分公司时，源地址为192.168.1.0/24，目的地址为10.1.1.0/24；当分公司访问分公司时，源地址为192.168.1.0/24，目的地址为10.2.2.0/24。

##内外地址重叠的问题

参考自[CISCO由器NAT中的地址重叠问题](http://www.zngps.com/article/2099.html)

当一个内部本地地址与所想连接的外部地址相同时，就发生了地址重叠。

如下图所示，主机A(148.1.1.1)想跟主机B建立一连接。当输入B主机名称后，DNS服务器进行主机名到主机地址的转换。而DNS服务器就给出了主机B的地址148.1.1.1，则**内部本地地址与外部地址发生了重叠**

![](http://ouzh4pejg.bkt.clouddn.com/nat2.jpg)

　CiscoIOS解决这一问题的方法是将**外部全局地址转换为外部本地地址**。由器A将执行以下步骤：

　　1)·主机A用主机B的主机名称请求与B建立一个连接，这是一个主机名称到地址的转换请求送往DNS服务器。

　　2)·DNS服务器有应答，把主机B的地址148.1.1.1返回。

　　3)·由器A截取报文并从**外部本地地址池**中选择一个外部本地地址**代替源地址**（是指B的地址）。

　　4)·由器A同时维持一张**全局地址到外部本地地址**的一张映射表。

　　5)·当主机A向主机B发送报文时，**目的IP地址就是外部本地地址**。

　　6)·而当由器A收到目的为外部本地地址的报文时，就把本地地址转换为全局地址。

**另外一种描述方式**

参考自[重叠网络NAT转换原理](http://book.51cto.com/art/201010/230408.htm)

![](http://ouzh4pejg.bkt.clouddn.com/nat3.jpg)
（1）内部网络中IP地址为1.1.1.1的主机通过计算机名向外部网络中的主机C发起连接。连接请求首先会向DNS服务器发出一个由名称到IP地址的查询请求，请求包在到达路由器之前的源地址为1.1.1.1主机的内部本地地址1.1.1.1，目的地址为DNS服务器地址。在到达路由器后，请求包的源地址被替换成1.1.1.1主机的内部全局地址2.2.2.2，目的地址不变。

（2）当DNS服务器发出的查询请求应答包（其中源地址为DNS服务器地址，目的地址为1.1.1.1主机的内部全局地址2.2.2.2，并包括了解析出的C主机的IP地址1.1.1.3）到达NAT路由器后，如果返回地址有重叠（也就是返回的地址在内部网络中已使用），将转换这个返回的地址。转换的方法是**创建一个简单的NAT条目，把解析得到的C主机IP地址1.1.1.3映射到一个从独立配置的外部本地地址池中分配到的外部本地地址3.3.3.3**，参见图中下面的NAT表项。

DNS服务器会检查每一个DNS应答，确保解析得到的IP地址不是在内部网络中已使用的IP地址，否则路由器将转换这个解析得到的IP地址。

（3）当解析到C主机的IP地址后，内部网络1.1.1.1主机会以映射后的3.3.3.3地址作为目的地址向外部网络C主机发起连接。

（4）路由器利用原来已获得的信息建立一个内部本地址、内部全局地址、外部本地地址和外部全局地址的NAT映射表，参见图中的NAT映射表项。

（5）路由器继续发送连接请求数据包，数据包的源地址用内部全局地址替换，数据包中的目的地址用外部全局地址替换，然后继续发送连接请求数据包。

（6）当外部网络主机C接收到这个数据包时，以一个应答数据包进行响应。应答数据名的源地址为C主机IP地址1.1.1.3，目的地址为内部网络全局地址2.2.2.2。

（7）当路由器接收到这个应答包时，把应答包中的目的地址用内部本地地址1.1.1.1进行替换，而源地址用外部本地地址1.1.1.3进行替换，转发给内部网络1.1.1.1主机。

**总结**
将重叠的**外部全局地址**转换为NAT条目中对应的外部本地地址


---
其他相关参考文章：

[在地址重叠环境中部署IPSec](http://xuanbo.blog.51cto.com/499334/410541/)

[重叠网络NAT转换原理](http://book.51cto.com/art/201010/230408.htm)

[CISCO由器NAT中的地址重叠问题](http://www.zngps.com/article/2099.html)

[网络基本功（十九）：细说NAT原理与配置](https://wizardforcel.gitbooks.io/network-basic/content/18.html)