# 第二章 - 软件安全基础

---

## 系统引导与控制权

![](http://ouzh4pejg.bkt.clouddn.com/lead.JPG)

#### BIOS： Basic Input and Output System
* 基本输入输出系统”，存储在主板BIOS Flash（或ROM）芯片。
* 为计算机提供最底层的、最直接的硬件设置和控制 。
* 自检与初始化工作
* 任务：检测系统中的一些关键设备（如内存和显卡等）是否存在和能否正常工作，进行初始化，并**将控制权交给后续引导程序**

#### 硬盘主引导程序
* 所在位置：
    BR，Master Boot Record，硬盘第一个扇区。
* 主要功能：
    * 通过主分区表中定位活动分区
    * 装载活动分区的引导程序，并**移交控制权**

#### 活动分区引导程序
* 所在位置：
    * DBR（DOS Boot Record），或称OBR（OS Boot Record），或称分区引导记录（PBR，Partition Boot Record）
    * 分区的第一个扇区
* 功能：
    * 加载**操作系统引导程序**
    * 如Windows XP系统的NTLDR
    
#### 操作系统引导－以Windows NTLDR为例
 将处理器从16位内存模式拓展为32位（64位）内存模
式
 启动小型文件系统驱动，以识别FAT32和NTFS文件系
统
 读取boot.ini，进行多操作系统选择（或hiberfil.sys
恢复休眠）
 检测和配置硬件（NT或XP系统，则运行
NTDETECT.COM，其将硬件信息提交给NTLDR，
写入“HKEY_LOCAL_MACHINE”中的Hardware
中）

#### 系统内核加载
 NTLDR加载内核程序NTOSKRNL.EXE以及硬件抽象层
HAL.dll等。
 读取并加载HKEY_LOCAL_ MACHINE\SYSTEM
\CurrentControlSet 下指定的驱动程序。
 NTLDR将把控制权传递给NTOSKRNL.EXE，至此引导过
程将结束。
    
#### 系统引导与恶意软件的关联
* 恶意软件在**计算机系统引导阶段**获得控制权
    * Bootkit：BIOS木马、MBR木马等，可用于长期驻留在系统；早期的DOS引导区病毒等。
    * CIH病毒

* 恶意软件在**操作系统启动阶段**获得控制权
    * 最常见的恶意软件启动方法，多见于独立的恶意软件程序。

* 在应用程序执行阶段获得控制权
    * 最常见的文件感染型病毒启动方法

## Windows内存结构与管理
#### Windows下的虚拟地址空间布局
* CPU特权级与内存访问
    * 与进程虚拟内存中用户模式区和内核模式区相对应，Windows为了确保系统的稳定性，将处理器存取模式划分为**用户模式（Ring 3）**和**内核模式（Ring 0）**。
    * 用户应用程序一般运行在用户模式，其访问空间局限于用户区；
    * 操作系统内核代码（如系统服务和设备驱动程序等）运行在内核模式，可以访问所有的内存空间（包括用户模式分区）和硬件，可使用所有处理器指令

* 用户区内存
    * 用户区是**每个进程真正独立**的可用内存空间，进程中的绝大部分数据都保存在这一区域。

    * 每个进程的用户区的虚拟内存空间**相互独立**，一般不可以直接跨进程访问，这使得一个程序直接破坏另一个程序的可能性非常小
    
* 内核区的内存
    * 内存内核区中的所有数据是所用进程**共享**的，是操作系统代码的驻地。

    * 该分区中所有代码和数据**都被操作系统保护**
    * **用户模式代码无法直接访问和操作**：如果应用程序直接对该内存空间内的地址访问，将会发生地址访问违规

#### 虚拟地址与物理地址的转换
Windows：虚拟页面通过**二级页表项**映射到物理内存
![](http://ouzh4pejg.bkt.clouddn.com/VA1.JPG)


![](http://ouzh4pejg.bkt.clouddn.com/VA2.JPG)

## 磁盘物理与逻辑结构
#### 磁盘与硬盘
* 磁盘又分为两类，一类是硬盘，一类是软盘

* 硬盘在机箱里面负责**储存数据**，而软盘用来**搬运数据**，硬盘的**容量大**，软盘的**容量小**，这就是它们的区别，另外**硬盘的存取速度比软盘快得多**

* 硬盘控制代码的静态存储仓库
    * 系统引导代码
    
    * 各类程序与数据
    
    * 恶意软件进行控制权争夺的中心

#### 硬盘的逻辑结构

* 磁盘的结构
    ![](http://ouzh4pejg.bkt.clouddn.com/SD.JPG)
    * 主引导扇区
        ![](http://ouzh4pejg.bkt.clouddn.com/main-lead-section.JPG)
        * 位于整个硬盘的0柱面0磁头1扇区（硬盘的第一个扇区）
        
        * MBR引导程序：占了其中的前446个字节
        
        * DPT（硬盘分区表）
        描述**各分区的基本信息**，分区开始位置、总扇区数，分区类型等
        * 结束标志：最后的两个字节“55AA”
    * 基本分区
    * 扩展分区
    ![](http://ouzh4pejg.bkt.clouddn.com/extend-section.JPG)
        * 扩展分区，严格地讲它不是一个实际意义的分区，它仅仅是一个**指向下一个分区的指针，这种指针结构将形成一个单向链表**。这样在主引导扇区中除了主分区外，仅需要存储一个被称为扩展分区的分区数据，**通过这个扩展分区的数据可以找到下一个分区(实际上也就是下一个逻辑磁盘)的起始位置，以此起始位置类推可以找到所有的分区**
        * 逻辑驱动器

## FAT32文件系统
#### 概念1：簇
* 文件系统**将磁盘空间以一定数目(2^n，n为整数）的扇区为单位进行划分**，这样的单位称为簇。

* 簇是进行**文件空间分配的最小单位**

#### 概念2：FAT表
* FAT表（File Allocation Table文件分配表）是Microsoft在FAT文件系统中用于**磁盘数据（文件）索引和定位**引进的一种**单向链式结构**

* FAT区用每一个**FAT项**来记录每一个**簇**的占用情况

* FAT表中**表项的个数=簇的个数**，FAT表**按顺序依次记录了该盘各簇的使用情况**，如果为0，则表示 对应簇空闲，可存储数据

* 每个表项有多大？
    * FAT16系统的FAT表占用16位，可表达的最大簇号空间为64K（2^16)
    * FAT32系统的FAT表占用32位，可表达的最大簇号空间为4G（2^32)

#### 概念3：簇链
* 一个文件所占用**簇的序号形成的单向链表**

* 实现方法：在文件占用簇的对应簇号的FAT项，**填写下一个簇的簇号**，如果为最后一簇，则输入结束标识“FFFFFFOF”

#### 文件存储
![](http://ouzh4pejg.bkt.clouddn.com/file-save.JPG)

* 目录项
为文件或子目录分配的**第一个簇的簇号，记录在它的目录项中**，其他后续簇则由“FAT 表”中的“FAT表链”进行跟踪，此外，还记录文件或子目录的名字、大小(子目录没有大小)、时间等元数据信息

* 文件删除
    * 目录项：
        * 文件名首字节被修改为E5
        * 首簇高位被清零
    
    * FAT表簇链：被全部清空
    
    * 文件内容：无变化

## PE文件格式
#### PE文件及其表现形式
PE文件：可移植的可执行文件（PE，Portable Executable file），Win32平台可执行文件使用的一种格式

#### PE文件格式与恶意软件的关系
* 文件感染［或控制权获取］
使目标PE文件具备［或启动］病毒功能［或目标程序］,但不破坏目标PE文件原有功能和外在形态（如图标）等

* 病毒代码如何与目标PE文件融为一体？
    * 代码植入
    * 控制权获取
    * 及图标更改等

* 一般来说，Win32病毒是这样被运行的（有些病毒是在HOST运行过程中**调用病毒代码**）
    * 用户点击（或者系统自动运行）HOST程序
    
    * 装载HOST程序到内存中
    
    * 通过PE文件的AddressOfEntryPoint和ImageBase之和来定位**第一条语句的位置**
    
    * **从第一条语句开始执行（病毒代码可能在此时，也可能在HOST代码运行过程中获得控制权）**
    
    * 病毒体代码主体执行完毕，将**控制权交换给HOST程序**
    
    * HOST程序体继续执行

#### PE文件格式总体结构
* MS-DOS MZ文件头（0x40）+

* DOS Stub
    * 作用：定位PE文件头**开始位置**，也可用于PE文件**合法性检测**

* PE Header
    * PE Header 开始于000000B0
    
    * PE Header由三部分组成
        * 字串“PE\0\0”(signature)
        值为50h，45h，00h，00h（PE\0\0），**本域为PE标记**，可以此识别给定文件是否为有效PE文件

        * 映像文件头（File_Header）
        结构域包含了关于PE文件**物理分布的信息**，比如**节数目、后续可选文件头大小，机器类型**等
        
        * 可选文件头（Optional_Header）
        定义了PE文件的很多关键信息：
            * 内存镜像加载地址（ImageBase）
            
            * 程序入口点（代码从哪开始执行）
            
            * 节在文件和内存中的对齐粒度
            
            * 本程序在内存中的镜像大小、文件头大小等
        
        * 几个概念
            * ImageBase:PE文件的优先装载地址；若该值为400000h，PE装载器将尝试把文件装到虚拟地址空间的400000h
            
            * RVA
            
            * 对齐粒度
            **SectionAlignment**：内存中节对齐的粒度
                **Filelignment**：文件中节对齐的粒度
                
            * **AddressOfEntryPoint**：PE装载器中准备运行的PE文件的第一条指令的RVA(病毒感染中通用关键字段)
            
            * PE文件内存映射方法
            系统在载入一个可执行程序时，首先是PE装载器把磁盘文件中的文件**映射到进程的地址空间**，它遍历PE文件并决定文件的哪一部分被映射，其方式是将文件较高的偏移地址映射到较高的内存地址中
            
            * FileOffset=RVA-Delta=VA-ImageBase-Delta

* 节表
    * 节表，是紧挨着PE Header的一个结构数组
    * 每个节均对应一个节表项：
        节名、节在文件和内存中的开始地址、长度节、属性

* 节
可执行文件的**核心部分**,PE文件一般有多个“节”，比较常见的有：
    * 代码节
    * 数据节
    * 引入函数节
    * 资源节（如图标）
    * 引出函数节（DLL文件中常见）
    * 重定位节（DLL文件中常见）
            
#### 代码节与数据节
每个PE文件都有代码节,代码节一般名为.text或CODE，该节含有程序的可执行代码

* 初始化的数据节
这个节一般取名为.data或DATA,已初始化的数据节中放的是在编译时刻就已确定的数据

* 未初始化的数据节
节名称一般叫.bbs,这个节里放有**未初始化的全局变量和静态变量**

#### 引入函数节：PE文件的引入函数机制
* 这个节一般名为.rdata。
    * 引入函数：是被程序调用但其执行**代码又不在程序中**的函数。
    
    * 这些函数位于一个或者多个DLL中，在调用者程序中**只保留了函数信息**，包括函数名及其驻留的DLL名等,动态链接库：例如kernel32.dll、user32.dll、gdi32.dll等

* IMPORT Directory Table

* IMPORT Name Table

* IMPORT Hints/Names &DLL names

* IAT（IMPORT Address Table）
    
#### 引出函数节：DLL文件的函数引出机制

#### 资源节：文件资源索引、定位与修改
* 资源节一般名为.rsrc,这个节放有如**图标、对话框等**程序要用到的资源

* 在病毒感染过程中，如果涉及图标替换，则涉及对资源节相关数据的处理

#### 重定位节
* 重定位节存放了一个**重定位表**。若装载器不是把程序装到程序编译时默认的基地址时，就需要这个重定位表来做一些调整。

* 重定位节以IMAGE_BASE_RELOCATION结构开始。

* 为什么需要重定位？
PE文件中部分数据是**以VA地址存储的**，当PE文件**无法加载到预期ImageBase时**，这些地址需要修正

#### PE文件执行时的内存布局

---

有些地方未完全，尤其是引入函数节部分，待复习ppt后再整理


2017.10.22
