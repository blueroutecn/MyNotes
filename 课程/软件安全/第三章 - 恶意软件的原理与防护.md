# 第三章 - 恶意软件的原理与防护

---

## 恶意代码及其分类

#### 恶意代码定义及其发作情况
* 恶意代码可能通过**软件漏洞、电子邮件、存储媒介或者其他方式**植入目标计算机，并随着**目标计算机的启动而自动运行**。

• 恶意代码的主要存在形态是**内存代码、可执行程序和动态链接库**

#### 恶意代码的功能
* 攻击目的
    * 恶作剧、炫耀等
    
    * 经济利益
    
    * 商业竞争
    
    * 政治目的
    
    * 军事目的等

* 攻击目标
    * 个人计算机
    
    * 服务器
    
    * 移动智能终端
        * 手机、平板等
    
    * 智能设备
        * 特斯拉汽车、智能家居、智能手表等
    
    * 通信设备
        * 路由器、交换机等
    
    * 安全设备等
        * 防火墙、IDS、IPS、VDS等

* 攻击目标范围：
    * 定点攻击
        * 邮件、IP、域名、QQ等
        * 服务器列表、特定人员名单等
    * 群体性杀伤
        * 挂马攻击、钓鱼攻击
        * 病毒、蠕虫自动扩散
* 恶意代码功能
* 获取数据
    * 静态数据：文件、数据库等；
    * 动态数据：口令、内存、计算机网络流量、通信网络数据、可移动存储介质、隔离电脑等
* 破坏系统
    * 数据：删除、修改数据；
    * 系统服务：通用Web服务系统，数据库系统，特定行业
    服务系统（如工控）等。
    * 支撑设备：网络设备、线路等
恶意代码的功能

* 动态控制与渗透拓展攻击路径等静态数据

#### 恶意代码的分类
![](http://ouzh4pejg.bkt.clouddn.com/mal-page1.JPG)

![](http://ouzh4pejg.bkt.clouddn.com/mal-type2.JPG)

![](http://ouzh4pejg.bkt.clouddn.com/mal-type3.JPG)

* 其他
    * 间谍软件（窃取个人信息）
    * 广告软件
    * 流氓软件（难以卸载）
* Exploit：精心设计的用于利用特定漏洞以对 目标系统
进行控制的程序

#### 恶意代码与网络犯罪

* **注意：病毒和蠕虫的区别是：是否需要用户干预**

* **注意：木马和后门的区别是：木马是自己安装的，后门是攻击者安装的**

## Windows PE病毒

#### PE病毒的基本概念
* 什么是PE病毒？
    * 以Windows PE程序为载体，能寄生于PE文件，或Windows系统的病毒程序。
* 什么叫感染？
    * 在**尽量不影响目标程序（系统）正常功能的前提下**，使其具有病毒自己的功能。

* 病毒自己的功能
    * 感染模块：**被感染程序同样具备感染能力**
    * 触发模块：在**特定条件下**实施相应的病毒功能
    * 破坏模块等

#### PE病毒的分类
* 感染目标型

|类型|感染方式|具体|
|:--:|:--:|:--:|
|文件感染|将代码**寄生在PE文件**|传统感染型<br>捆绑释放型|
|系统感染|将代码或程序**寄生在Windows操作系统**|即时通信软件<br>U盘、光盘<br>电子邮件|

#### 传统文件感染型
* 感染思路

![](http://ouzh4pejg.bkt.clouddn.com/trad-file-infect.JPG)

* 关键技术

|关键技术|问题|
|:--:|:--:|
|**重定位**|病毒代码目标寄生位置不固定（与shellcode一致）|
|**API函数自获取**|需要使用的API函数，但无引入函数节支撑|
|**目标程序遍历搜索**|全盘查找，或者部分盘符查找|
|**感染模块**|病毒代码**插入位置选择与写入**<br>控制权返回机制|

* 文件感染
**感染的关键**

* **病毒代码能够得到运行**
* 选择合适的位置**放入病毒代码（已有节，新增节）**
* 将控制权交给病毒代码
    * 修改程序入口点：AddressofEntryPoint
    * 或者在原目标代码执行**过程中运行病毒代码（EPO技术，EntryPoint Obscuring）**

* 程序的**正常功能不能被破坏**
    * 感染时，记录原始“程序控制点位置”
    * 病毒代码执行完毕之后，返回控制权
    * 避免重复感染：感染标记

* 代码插入位置－1
    * **添加新节**,增加一个节专门存放病毒代码。要事先**检查节表空间是否足够**。
* 碎片式感染
    * 将代码**分解**，插入到节之间的**填充部分**

* 代码插入位置－2
    * 插入式感染
        * 将病毒代码插入到**HOST文件的代码节的中间或前后**。
        * 这种感染方式会增加代码节的大小，并且可能修改HOST
        * 程序中的一些参数实际位置导致HOST程序运行失败。
    * 伴随式感染
        * 典型方法：备份HOST程序，用**自身替换HOST程序**
        * 当病毒执行完毕之后，再将控制权交给备份程序

* 添加新节的感染方式
暂略却步骤，见ppt：软件安全第三章（2）
            
#### 捆绑释放型
* 将HOST作为数据**存储在病毒体内**，当执行病毒程序时，还原并执行HOST文件



#### 系统感染型病毒
* 这类病毒通常为独立个体，不感染系统内的其他文件

* 如何再次获得控制权
    * 自启动
* 如何传播
    * 可移动存储介质（U盘、移动硬盘、刻录光盘等）
    * 网络共享
    * 电子邮件或其他应用

## 宏病毒与脚本病毒

#### 宏的基本概念与使用
* 宏
    * 宏就是**能组织到一起作为独立的命令**使用的一系列**word命令**，可以实现任务执行的**自动化**，简化日常工作。

#### 宏病毒的传播方法
* 宏病毒
• 存在于**数据文件或模板**中（字处理文档、数据表格、数据库、演示文档等），使用
宏语言编写，**利用宏语言的功能将自己寄生到其他数据文档**

* 控制权获取
将病毒代码写在能够**自动执行的宏**中，由于这些宏会自动执行，因此获取控制权

* 宏病毒的感染
    * 在Word和其他微软Office系列办公软件中，宏分为两种。
        * 内建宏：位于文档中，对**该文档**有效，如文档打开（AutoOpen）、保存、打印、关闭等。
        * 全局宏：位于office模板中，为**所有文档所共用**，如打开Word程序（AutoExec）。

* 宏病毒的传播路线：
    * 单机：单个Office文档—〉Office文档模板—〉多个Office文档
    * 网络：电子邮件居多

* 宏病毒的感染方案
    * 让宏在这两类文件之间**互相感染**：数据文档、文档模板

* 如何感染
    * 代码导入与导出
    * 网络传播
    
#### 宏病毒的自我保护
* 禁止提示信息

* 屏蔽命令菜单，不允许查看宏

* 隐藏宏的真实病毒代码
    * 在“自动宏”中，不包括任何感染或破坏的代码，但包含了**创建、执行和删除新宏（实际进行感染和破坏的宏）的代码**
    
    * 将宏代码字体颜色设置成**与背景一样的白色**等

#### VBS脚本的概念及使用

#### VBS脚本病毒的传播方法
* 定义
用VBScript编写，能够进行**自我传播的破坏性程序**，其需要**人工干预**触发执行

* 如何感染文件
在代码中有自我复制的语句，通过**自我复制**来感染文件，病毒中的绝大部分代码都可以直接附加在其他同类程序中

* 如何搜索目标
通过代码中的函数寻找符合条件的文件，并生成对应文件的一个病毒副本

* VBS病毒生产机
    * 脚本语言的特点：
        * 解释执行、不需编译
        * 程序无需校验
        * 每条语句之间分隔清晰
        * 模块执行位置不敏感
* VBS病毒生产机：
    * 病毒功能模块化，供用户进行病毒或参数功能，然后根据配置进行代码组合和参数修改，最后生成即可


#### VBS脚本病毒的自我保护
* 自变换与加密

* 巧妙运用Execute函数

* 改变某些对象的声明方法（躲避检测）

* 尝试关闭反病毒软件
VBS脚本可以**查看系统正在运行的进程或服务，尝试关闭和删除相应的关
键程序**

## 网络蠕虫

#### 网络蠕虫的定义

* 蠕虫
    
    * 一组能够进行自我传播，**不需要用户干预**来即可触发执行的破坏性程序或代码。

    * 通过不断搜索和侵入**具有漏洞的主机**来自动传播
    
    * eg.红色代码、SQL蠕虫王、冲击波


* 计算机病毒

    * 一组能够进行自我传播，**需要用户干预**来出发执行的破坏性程序或代码。
    
    * eg. CIH,爱虫、美丽莎等

#### 网络蠕虫的分类

按照**传输渠道**和**获取控制权方法**划分


* 漏洞利用类蠕虫-ExploitWorm

    * Slammer、MsBlaster、Sasser、StuxNet等

* 口令破解类蠕虫-PassWorm

    * 通过弱口令进入目标系统，如2003年“口令蠕虫”

* 邮件传输类蠕虫－MailWorm
    * Sobig、Mydoom、@mm类

* 即时通信类-IMWorm
    * QQ尾巴、MSN性感鸡等

* P2PWorm、IRCWorm、USBWorm等

#### 网络蠕虫的功能模块
网络蠕虫基本功能（四个主要模块0

* 信息收集：主要完成对**本地和目标节点主机的信息汇集**

    * 目的：对本地或者目标网络进行信息收集，为发现**易感染目标**提供支持

    * 搜集信息包括：本机系统信息、用户信息、对本机的信任或授权的主机、本机所处网络的拓扑结构、边界路由器信息

* 扫描探测：发现易感染主机群体
    * 目的：完成特定目标的**脆弱性检测**，**发现易感染目标（主机）**

    * 影响网络漏洞传播的因素：取决于**漏洞自身以及漏洞的利用机制**
    
    * 扫描策略： 如何**更快地覆盖易感染群体**
    
* 攻击渗透：利用已发现的服务漏洞实施攻击（控制权获取）

    * 目的：该模块利用安全漏洞建立**获取目标系统的控制权**

* 自我推进：完成对目标节点的感染（蠕虫主体程序传输）

    * 目的：该模块在本机与目标主机之间完成**蠕虫副本传递**（eg.文件直接传输、搭建Web等服务器、P2P等）


#### 网络蠕虫的检测与防治

* 个人用户

    * 及时修补漏洞补丁

    * 使用防火墙软件阻断

    * 安全防护软件及时更新
    
* 网络管理者

    * 网关阻断

    * 补丁下发
    
* 安全厂商

    * 网络流量特征分析与提取
    
    * 网络安全设备快速阻断
    
    * 快速利用客户端安全软件清除蠕虫个体，并进行补丁修补
    
* 网络应用厂商

    * 应用流量过滤与阻断

    * 补丁自动分发与修补

## 网络木马

#### 木马的基本概念

* 定义
    * 通过**欺骗或诱骗**的方式安装，并在用户的计算机中**隐**藏以实现**控制用户计算机**的目的。

    * 具有**远程控制、信息窃取、破坏**等功能的恶意代码；

    * 特点： 欺骗性、隐藏性、非授权性、交互性

#### 木马的分类

* 行为视角（粒度细，如卡巴斯基SafeStream病毒库的分类标准）

* 功能视角
    * 远程控制型
    
    * 信息获取型
    
    * 破坏型等

#### 木马的植入方式

* 网页挂马植入
• 自动下载安装（MS06014,MS10002）

* 电子邮件植入
    * 附件形式，打开附件被植入
    * 电子邮件与恶意网页相结合，即使不打开附件，选中就会被植入（以HTML格式发送，如求职者）

* 文档捆绑植入
    * office文档、pdf文档漏洞等
    
* 伪装欺骗植入
    * 更改后缀名（Unicode翻转字符）、图标伪装

* 捆绑植入
    * EXE捆绑、文档嵌入、多媒体文件、电子书植入

* 其他
    * 特定U盘植入（故意丢弃、或者工作U盘、数据拷贝等）

    * 社会工程
    
#### 木马的通信方式
* 传输通道构建信息
    * IP地址
    
    * 端口等信息
    
    * 第三方网站地址

* 建立通信连接的方式
    * 正向连接
    * 反向连接

* 正向连接
    * **控制端主动连接被控端**

    * 优点
        * 攻击者无需外部IP地址
        * 木马样本不会泄露攻击者IP地址

    * 缺点
        * 可能被防火墙阻挡
        * 被攻击者必须具备外部IP地址
        * 定位被攻击者相对困难
        
* 反向连接-1
    * **被控制端连接控制端**

    * 优点

        * 通过防火墙相对容易
        * 攻击目标随时上线、随时控制
        * 可以控制局域网内的目标

    * 缺点：
        
        * 样本会暴露控制服务器信息（域名或IP）
        
        * 攻击者通常应当具有外部IP
        
* 反向连接-2
    * 被控制端和控制端和**第三方通信(Web服务器、肉鸡)**

    * 优点
        * 可绕过防火墙，自动连接上线，不易被发现（代理）
    
    * 缺点
        * **肉鸡**的稳定性需要保障
        
* 通信协议
    * TCP协议
        * 稳定、易被发现
        * HTTP协议伪装

    * UDP协议
        * 和TCP一样也有正向、反向两种方式
        * 负载比TCP少，但是可靠性低
        
    * ICMP＋TCP／UDP

        * 监听ICMP报文，以感知木马数据

            * ICMP报文是由**系统内核或进程直接处理**而不是通过端口

            * 一般**不会被防火墙过滤**
            
        
#### 木马的常见功能

* 木马结构

    * 木马配置程序
    
    * 控制端程序（客户端）
    
    * 被控制端程序（服务端程序)
        
* 典型功能

    * 文件管理

    * 进程管理

    * 服务管理

    * 注册表管理

    * 屏幕监控、屏幕截取

    * 语音视频截获

    * 键盘记录

    * 窗口管理

    * 远程Shell等
    
* 木马的关键

    * 功能适当［精简灵活］

    * 适用性强［功能、权限］

    * 高效、稳定、隐蔽［传输］

    * 可穿透性

    * 自更新、自销毁

    * 防追踪、反制对抗

    * 持续免杀性能等

    * 特征值、通用主机行为、异常的通信流量…

#### 木马的检测思路
* 静态文件特征

* 网络流量特征

* 系统行为特征

* 攻击意图等

## 恶意代码检测技术

#### 恶意代码检测对象与策略
* 恶意代码的检测
    * 将**检测对象**与**恶意代码特征（检测标准**）进行对比分析，**定位病毒程序**或**代码**，或**检测恶意行为**
    
* 检测对象主要包括
    * 引导扇区
        * 检测目标：引导扇区病毒、MBR木马等

    * 文件系统中可能带毒的文件
        * 可执行程序
            * exe;.dll;.com;.src……
        * 数据文件
            * .doc;.xls;.ppt;.pdf;.mp3;.avi……
        * 脚本文件
            * .js;.vbs;.php;.pl……
        * 网页文件
            * .html;.html;.asp

    * 内存空间
     恶意代码在传染或执行时，必然要占有一定的内存空间，**部分功能代码驻留在内存中**。
     
    * 主板BIOS等

    * 网络流量，系统行为等

#### 特征值检测技术
* 反病毒软件鉴别特定计算机病毒的一种标志。通常是**从病毒样本中提取的一段或多段字符串或二进制串**

* 具体思路
    **获取样本 → 提取样本特征 → 更新 → 病毒库 → 查杀病毒**

* 特征值标记
    * 特征字串
    * 感染标记

* 优缺点
    * 优点：**检测速度快、误报率低**

    * 缺点：只能检测已知恶意代码，**容易被免杀绕过**
    
* 恶意软件的对抗
    * 手工修改自身特征

    * 自动修改自身特征（加密、多态、变形）
    
#### 校验和检测技术
* 在文件使用/系统启动过程中，**检查检测对象的实际校验和与预期是否一致**，因而
可以发现文件/引导区是否感染。
    * 预期：正常文件内容和正常引导扇区数据

* 校验和检测对象
    * 文件头部

    * 文件属性

    * 文件内容

    * 系统数据等
    
* 优点
    * 方法简单
    * 能**发现未知病毒**
    * 目标文件的**细微变化**也能发现

* 缺点
    * 必须预先记录正常文件的校验和（预期）
    * 误报率高
    * 不能识别病毒名称
    * 效率低
    
#### 启发式扫描技术
* 启发式代码扫描技术（Heuristic Scanning）实际上就是恶意代码检测**经验和知识的软件
实现**

* 优点

    * 能够**发现未知病毒**

* 缺点

    * 误报率高

* 解决方案
    * **启发式扫描技术+传统扫描技术**
    
    * 可提高病毒检测软件的检测率，同时有效降低了总的误报率

#### 虚拟机检测技术
* 为什么需要虚拟机检测技术？

    * 加密、多态、变形病毒的出现

    * 加壳技术

    * 加密病毒
        * 真实代码被压缩或加密，但最终需要在内存中还原
        
* 在反病毒系统中设置的一种程序机制，他能在内存中**模拟一个小的封闭程序执行环境**，所有待查文件都已解释方式在其中被**虚拟执行**

* 优点
    * 有效处理加密类病毒
    
    * 虚拟机技术+特征值扫描，准确率更高
    
    * 虚拟机技术+启发式扫描，有利于检测未知变形病毒


#### 主动防御技术
* 主动防御检测技术有时也被称为**行为监控等技术**

* 动态监视所运行程序调用各种应用编程接口（API）
的动作，**自动分析程序动作之间的逻辑关系，自动判定程序行为的合法性**

* 监控应用程序的敏感行为，并向用户**发出提示，供用户选择**

* 可疑行为举例
    * 安装、加载驱动
    * 键盘钩子
    * 自我隐藏
    * 下载并执行

* 优缺点
    * 优点：
        * 可发现**未知恶意软件**、可准确地发现未知恶意软件的**恶意行为**
    
    * 缺点：
        * 可能**误报警**
        * 不能识别恶意软件名称
        * 实现时有一定**难度**
    
#### 安全软件评测

eg. virustotal 等

## 恶意软件样本捕获与分析

#### 恶意软件样本捕获方法

* 蜜罐

    * 通常是指**未采取安全防范措施**、并且将模拟的程序**漏洞主动暴露在网络中**的计算机。
    
    * **引诱恶意软件样本来攻击**这类蜜罐计算机设备。
    
    * 特点
        * 引诱恶意软件在蜜罐内**更加充分的运行，并记录下其行为**
    
    * 分类
    
        * 主动型蜜罐
        ![](http://ouzh4pejg.bkt.clouddn.com/active-honeypot.png)
        
        * 被动型蜜罐
         ![](http://ouzh4pejg.bkt.clouddn.com/passive-honeypot.png)
            
* 用户上报
    * 由个人用户在使用电脑过程中，**发现恶意样本后主动上报给安全研究人员或机构**
    
    * 上报途径
        * 的官方论坛、上传接口、在线分析平台，如VirusTotal、Anubis等
    
    * 特点
        * 用户上报的样本通常较新，有一定的代表性

* 云查杀平台
    * 目的
        * 云端查杀，**降低对用户主机的性能开销**
        
        * 利用大数据分析、机器学习等，结合启发式分析，实现对**未知恶意软件的发现和查杀**
    
    * 优点
        * 样本空间广泛，大大提高恶意软件的查杀能力
    
    * 缺点
        * 易造成个人隐私或企业机密数据的泄露

    
* 诱饵邮箱

    * 在21世纪初，很多计算机病毒都使用电子邮件传播，用户在打开电子邮件或其附件时中毒。
    
    * 通过诱饵邮箱捕获样本的工作流程
    注册大量邮箱 → 公布在网上 → 获取收集到的样本
    
    * 针对个人的各**类APT攻击行为**中，电子邮箱也是主要入侵渠道之一。因此，诱饵邮箱依然可以发挥重要作用。

* 样本共享

    * 开放社区，用于样本分析、研究等（eg.卡卡饭论坛）

#### 恶意软件载体

* 在彻底清除主机内的恶意软件时，需要**定位恶意软件的来源、传播方式和存在形式**，即**载体**。

* 不同类型的恶意软件有**不同的传播方式与存在形式**

* 具体内容

    * 文件感染型病毒
    
    * 蠕虫、木马类恶意软件
    
    * 宏病毒
        * **可疑文档**或**Word、Excel、PowerPoint的模板文**件是这类病毒的主要载体。
    
    * 电子邮件病毒（附件为载体）
    
    * 脚本病毒
        * 触发漏洞的恶意代码通常**藏匿于脚本中**
    
    * 应用程序重打包（Android App）
        * 完整性校验：与原版App进行对比，即可**定位出插入到重打包app中的恶意代码**
            
#### 恶意软件样本分析方法

* 样本分析目的
    * **取证分析、持续威胁的追踪和溯源**
    
    * 理解其**工作机理和行为特征**

    * 实现或完善相应的安全监测机制
    
    * 实现对已有恶意软件和未知恶意软件的防御、监
测
![](http://ouzh4pejg.bkt.clouddn.com/analyze-purpost.png)
    
    
* 分析方法

 ![](http://ouzh4pejg.bkt.clouddn.com/analyze_way_1.png)
 
  ![](http://ouzh4pejg.bkt.clouddn.com/analyze_way_2.png)

#### 恶意软件样本分析工具

* 常用分析工具介绍
    * 虚拟机
    
    * 系统监控

    * 进程监控
    
    * 注册表监控
    
    * 文件行为监控
    
    * 网络行为监控
    
    * 反汇编软件
    
    * PE文件分析软件
    
    * 动态调试软件
    
* 恶意软件分析报告
    * 样本基本信息

    * 样本行为基本信息
    
* 恶意软件样本分析步骤

    * 获取文件基本信息
    
    * 在线分析和检测平台，获取样本的基本行为信息（Anubis平台、文件B超、金山火眼）
    
    * 对关键模块进行静态分析
    
    * 对关键模块进行动态调试
    
    * 总结、完成报告
