# 第七章 - 防火墙技术

---

## 包过滤技术

#### 包过滤原理
通过检测网络数据包的**信息头**决定是否将数据包发往目的地址，以达到对流入和流出网络的数据进行监测和限制的目的

#### 包过滤模型
* 包过滤防火墙的核心是**包检查模块**

* 防火墙检查模块验证每个包**是否符合过滤规则**，不管是否符合过滤规则，防火墙一般**都要记录数据包情况**

（其他具体见ppt）
#### 包过滤技术
* 数据包过滤功能的实现依赖于**包过滤规则**，有时也称之为**访问控制列表**

* 为了保证**所有**流入和流出的网络的数据包都被监控和检测，包过滤器必须被放在**网络单点访问**的位置

* 包过滤技术虽然是防火墙技术的一部分，在实际应用中也往往和**边界路由器**集成使用

![](http://ouzh4pejg.bkt.clouddn.com/firewall-model.JPG)

###### 配置访问控制列表
* 静态访问控制列表
    * 本质上，一个**包过滤**防火墙由:
        * 一个脏端口：**连接Internet**，来自Internet和流向Internet的数据流都由此端口通过。
        * 一个净端口：**连接内部网络**，防火墙一般认为内部网络完全可信，网络安全威胁来自网络外部。
        * 一组**访问控制规则**组成
    
    * 配置访问控制表
        * 限制策略。接受受信任的IP包，拒绝其他所有IP包。
        * 宽松策略。拒绝不受信任的IP包，接受其他所有IP包
    

* 动态访问控制列表
    * 动态包过滤技术是指配置动态访问控制列表
    * 动态包过滤技术一般结合**身份认证机制实现**
    * 过程：
        * Ⅰ.用户发起一个到防火墙的Telnet会话。
        * Ⅱ.防火墙接收到Telnet数据包分组后，打开Telnet会话，提示用户输入认证信息并对用户身份进行验证。
        * Ⅲ. 通过身份认证后，用户退出Telnet会话，防火墙访问控制列表内创建一个临时条目。该临时条目可限制用户临时访问的网络范围。
        * Ⅳ. 用户通过防火墙交换数据。
        * Ⅴ. 超过预定超时时间（Timeout）后，防火墙将删除这个临时访问控制列表规则，系统管理员也可手动删除


* 状态包检查
    * 状态包检查技术又称为**反射访问控制列表**技术。
    * SPI（Stateful Packet Inspection）技术能够动态建立访问控制列表条目，在这些临时条目中不仅包含必要的**包过滤信息**，还包含了网络会话的**状态信息**，这些临时条目在**新会话开始（如内部主机向外部主机发起连接请求）时创建**，并在会话**结束时被删除**

#### 包过滤技术优缺点
* 优点
    * 包过滤防火墙是两个网络之间访问的**惟一途径**，防火墙可对**每个**传入和传出网络的数据包实行低水平控制
    * 每个**IP包的字段都被检查，如源地址、目的地址、协议、端口等**。防火墙将基于这些信息应用过滤规则
    * 防火墙可以**识别、丢弃带欺骗性源IP地址**的包
    * 包过滤通常被**包含在路由器中**，不需要额外的系统来处理

* 缺点
    * 访问控制列表的**配置和维护困难**
    * 包过滤防火墙难以详细了解主机之间的会话关系，容易受到欺骗。
    * 基于**网络层和传输层**实现的包过滤防火墙难以实现对**应用层服务的过滤**
        

## 网络地址翻译技术
* NAT（Network Address Translation，网络地址翻译）的最初设计目的是用来**增加私有组织的可用地址空间**和解决将现有的**私有TCP/IP网络连接到互联网上的IP地址编号问题**

* 互联网网络号分配机构（IANA，Internet Assigned Numbers Authority）规定了**私有IP地址空间**

![](http://ouzh4pejg.bkt.clouddn.com/private-ip.JPG)

#### NAT技术原理
* 内部网 → 外部网： 源地址 → 全球同一可寻址ip地址

* 外部网 → 内部网： 源地址 → 内部网络私有ip地址

* NAT技术中，通信**通常由内部网络发起**

* 网络地址翻译技术并非为防火墙而设计，它在解决IP地址短缺的同时提供了**内部主机地址隐藏功能**，使其成为防火墙实现中经常采用的核心技术之一

#### NAT相关术语
* 内部局部地址（Inside Local Address）：在**内部网络**中使用，内部网络分配给主机的私用IP地址。

* 内部全局地址（Inside Global Address）：在**外部网络**中使用，标识内部网络的主机。一般是由互联网服务提供商（ISP）提供的一个合法IP地址。
    * 在互联网中代表一个**虚拟的主机**，对应了内部网络中**一个或多个内部局部IP地址**


* 外部全局地址（Outside Global Address）：在**外部网络**中使用，标识外部网络的主机。一般是由互联网服务提供商（ISP）提供的一个合法IP地址。

* 外部局部地址（Outside  Local Address）：在**内部网络**中使用，标识**外部网络的主机**，是从私有IP地址空间中分配的
    
#### 静态网络地址翻译技术
* 如果网络地址翻译技术完全依赖于**人工指定内部局部地址和内部全局地址**之间的映射关系来运行，称为静态网络地址翻译技术

* 过程
    * 手工建立静态NAT表
    * 内外网建立会话连接
    * 对从内部收到的NAT数据包检测NAT映射表，并转发
    * 外部主机收到数据包并应答  
    * 防火墙收到外部发来的数据包，检测NAT表，如**有映射记录则进行转换并转发，没有则拒绝该数据包**


#### 动态网络地址翻译技术
* 定义:如果NAT映射表由**防火墙动态建立**，对网络管理员和用户透明，则称之为动态网络地址翻译技术

* 从本质上讲，网络地址映射并**不是简单的IP地址之间的映射，而是网络套接字映射，网络套接字由IP地址和端口号共同组成**

* 过程
    * 内外网建立会话连接
    * 防火墙接收到来自某内部主机的数据包时检查NAT映射表：如果还没有为该内部主机建立地址转换映射项，然后进行转换；如有映射记录则直接转换
    * 防火墙进行地址转换后转发数据包。
    * 外部主机收到访问信息并应答。
    * 防火墙接收到来自外部网络的数据包时，检查NAT映射表查询匹配项：**如果NAT映射表中存在地址映射和会话状态匹配的选项，则转发数据包；否则，拒绝数据包**



#### 网络地址翻译技术实现负载均衡
* 为什么要进行负载均衡？
![](http://ouzh4pejg.bkt.clouddn.com/balance-reason.JPG)

* 负载均衡原理
![](http://ouzh4pejg.bkt.clouddn.com/balance-theory.JPG)

* 解决方案一:服务器负载均衡
多台服务器组成一个**群组**，通过网络设备相连接。服务器群组前布局一个**负载均衡设备**，负责根据已配置**均衡策略**将用户请求在服务器群组中的分发

* 解决方案二：链路负载均衡
通过**带宽**或**就近性**等算法，在多条链路中进行负载均衡，**选择最优的链路**，  提高访问速度

* 网络地址翻译技术实现负载均衡:为不同的会话连接，将目的ip映射为不同的内部局部地址（自己理解的）

#### 网络地址翻译技术处理网络地址交迭
具体内容见[NAT重叠地址处理](https://github.com/carrie0307/Notes/blob/master/%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86/NAT%E9%87%8D%E5%8F%A0%E5%9C%B0%E5%9D%80.md)

#### 网络地址翻译技术优缺点
* 一些应用层协议的工作特点导致了它们无法使用网络地址翻译技术。当端口改变时，有些协议不能正确执行它们的功能

* 静态和动态网络地址映射安全问题
    * 静态：虽然可以**屏蔽内部网络的拓扑结构**，但对内部主机并未提供额外的保护功能，**非法数据包**可以像有效连接请求一样被翻译
    * 动态
        * 在**内部主机建立穿越防火墙的网络连接之前，相应的NAT映射并不存在**。网络外部主机根本没有到达内部主机的路径，因此网络内部主机完全被屏蔽，不可能受到攻击。
        * 对于**内部网络攻击**，NAT不存在任何安全保护
        * 可以使得黑客难以了解网络内部结构，但是**无法阻止内部用户主动连接黑客主机**
        * NAT映射条目生命周期的问题

## 网络代理技术

#### 应用层代理

##### 应用层代理简介
* 应用层代理技术针对每一个**特定应用**进行实现，在应用层实现**网络数据流保护功能**

* 代理的主要特点是具有**状态性**

* 对**外部网**来说，外部网所见到的只是**代理服务器**，因为它**收到的请求都来自代理服务器**，对**内部网**来说，客户机所能直接访问的只是**代理服务器**

* 外部网络主机通过应用)层代理访问内部网络主机，内部网络主机只接受应用层代理提出的服务请求，**拒绝外部网络节点的直接请求**。当应用层代理接受外部网络节点提出的服务请求时，它对该用户的身份进行验证，若为合法用户，**则把该请求转发给某个真正的内部网络主机**

![](http://ouzh4pejg.bkt.clouddn.com/appilication-proxy.JPG)

##### 应用层代理的实现
* 应用层代理往往通过一台**双宿主机**或**堡垒主机**实现

* 应用层代理允许用户访问，但不允许用户注册到应用层代理主机上。
    * 入侵者可能会利用这些帐号阻挠或破坏防火墙有效性的操作。

* 应用层代理一般只向**单个或部分**主机提供网络服务，而不是向所有主机。具有访问能力的主机可作为那些没有访问权限的主机的代理而形成多层代理模式。

* 代理服务器工作在应用层，因此可以提供**应用层服务控制**，起到外部网络与内部网络进行通信时的**中间转接、监控、限制和审计**等作用

![](http://ouzh4pejg.bkt.clouddn.com/application-proxy-2.JPG)

##### 代理服务程序
* 对于一些服务，可以**容易或自动提供代理**，这些服务可以通过对**正常服务器的配置**来设置代理

* 但对大多数代理服务来说，要求有**合适的代理服务器软件**，需要针对不同服务的代理功能开发不同的代理服务程序。在客户端可以有不同的方法。

##### 应用层代理技术的优缺点分析

* 优点
    * 应用层代理工作在**应用层**，和包过滤技术相比能够实现对网络数据包**更加细粒度的监测、审计和控制**，主要表现在：
        * 有能力支持**可靠的用户认证**并提供**详细的注册信**息；
        
        * 用于应用层的**过滤规则**，相对于包过滤路由器来说**更容易配置和测试**
        
        * 应用层代理工作在客户机和真实服务器之间可以完全控制网络会话，可提供详细的日志和安全审计功能；
        
        * 提供代理服务的防火墙可以被配置成**惟一的可被外部看见的主机**，这样可以隐藏内部网的IP地址，保护内部主机免受外部主机的进攻；
        
        * 通过代理访问Internet可以解决**合法的IP地址不够的问题**。Internet所见到只是代理服务器的地址，内部IP可以通过代理访问Internet

* 缺点
    * **有限的连接性**：代理服务器一般具有解释应用层命令的功能，如解释FTP命令、Telnet命令等，那么这种代理服务器就只能用于**某一种服务**。因此，可能需要提供**多种不同的代理服务器**，如FTP代理服务器，Telnet代理服务器等，所以**能提供的服务和可伸缩性有限**
    
    * **技术有限**：应用层代理很难为RPC、Talk和其他一些基于通用协议族的服务提供代理；
    
    * 应用层实现的防火墙会造成明显的**性能下降**
    
    * **每个应用程序都必须有一个代理服务程序来进行安全控制**，每一种应用升级时，相应代理服务程序也要升级，**维护相对复杂**

    * 应用层代理要求用户**改变自己的行为**，或在访问代理服务器的每个系统上**安装特殊的软件**。比如，通过应用层代理Telnet的访问，可能要求用户通过两步而不是一步来建立连接
    
    * 应用层代理对**操作系**统和应用层的**漏洞**是脆弱的，不能有效检查底层的信息，传统的代理也很少是透明的
    
* 从历史发展的观点来说，应用层代理应适应Internet通用用途和需要。
Internet的环境在不断动态变化，新的协议、服务和应用在不断出现，代理应该能够处理Internet上各种类型的传输，满足新的商业需求，胜任用户对网络高带宽和安全性的需要。

            
#### 电路级代理

##### 电路级代理概述

* 应用层代理为**特定的服务**（如FTP, Telnet等）提供代理服务，它不但转发流量而且**对应用层协议做出解释**。电路级代理（通常也称为电路级网关或回路级代理）也是一种代理，但只是建立起一个回路，对数据包**只起转发的作用**

* 电路级网关是一个**通用代理服务器**，它工作于OSI互联模型的**会话层**或是**TCP/IP协议的TCP层**

##### 电路级网关的工作原理
* 电路级网关依赖于**TCP连接**，并不进行任何附加的包处理或过滤

* 数据包被提交给**应用层**来处理

* 电路级网关只是在两个通信终点之间**转接数据包**，将简单的字节来回复制

* 连接起源于防火墙，**隐藏了受保护网络的有关信息**

* 电路级网关**对外像一个代理**，而**对内则是一个过滤路由器**，这种代理的优点是它可以**对各种不同的协议提供服务**

![](http://ouzh4pejg.bkt.clouddn.com/proxy.JPG)

* 一个简单的电路级网关仅传输TCP的数据段，**增强的**电路级网关还应该具有**认证功能**


##### SOCKS代理技术
* SOCKS协议是－个电路级网关的标准，SOCKS协议可以通过**中继TCP数据包**实现功能强大的**电路级网关防火墙**，而对应用层不需要作任何改变

![](http://ouzh4pejg.bkt.clouddn.com/socks.JPG)

* SOCKS防火墙工作原理

* 代理主要由两部分组成：
    * SOCKS服务端程序。直接同Internet和内部网络通信的程序；

    * SOCKS客户端程序。经过修改的Internet客户程序。它将使运行客户程序的主机同运行服务程序的主机通信，而不是直接与Internet通信

##### SOCKS代理的实现
* SOCKS客户程序替换了UNIX中的一些套接字函数，如connect( )，getsocketname( ),bind( ),listen( )和select( )。可以通过在Makefile文件中增加了一些宏定义FLAGS，然后编译，达到在应用程序中链入SOCKS库函数的目的。

* 当一个经SOCKS修改的客户程序连接到Internet上时，SOCKS库中的子程序就**截获这个连接，并连接到运行SOCKS代理服务器的主机上，而不是的Internet**。当连接建立后，SOCKS客户程序发送如下信息：版本号、连接请求命令、客户端的端口号、发起连接的用户名等

* SOCKS代理服务进程将**检查访问控制表，判断应该接受还是拒绝这个连接**
    * 如果连接被接受，SOCKS服务进程将打开一个与远程主机的连接，然后在这两主机间传递信息
    
    * 如果连接被拒，SOCKS服务进程就断开连接



